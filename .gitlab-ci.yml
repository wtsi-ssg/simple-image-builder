variables:
 IMAGE_NAME_BIONIC_LUSTRE: "bionic-WTSI-lustreonly_${CI_PIPELINE_ID}"
 IMAGE_NAME_BIONIC_LUSTRE_DOCKER: "bionic-WTSI-lustre_docker_${CI_PIPELINE_ID}"
 OS_NO_CACHE: "True"
 COMPUTE_API_VERSION: "1.1"
 no_proxy: ",172.27.66.32" 
 OS_CLOUDNAME: "overcloud"
 OS_AUTH_BASE: "https://theta.internal.sanger.ac.uk:5000/"
 OS_AUTH_URL: "$OS_AUTH_BASE/v3"
 OS_DOMAIN_NAME:  "Default"
 OS_IDENTITY_API_VERSION: 3
 OS_IMAGE_API_VERSION: 2
 OS_REGION_NAME: "RegionOne"
 NOVA_VERSION: "1.1"
 USE_PACKER_BIN: "/software/packer-1.6.1/bin/packer"
 OS_BASE_IMAGE_FOCAL: "ubuntu-20.04-server-cloudimg-amd64"
 OS_BASE_IMAGE_BIONIC: "bionic-server"
 OS_BASE_IMAGE_CENTOS7: "CentOS-7-2019-01-28"
 OS_SECURITY_GRP: "cloudforms_ssh_in"
 proxy: "http://wwwcache.sanger.ac.uk:3128"
 UBUNTU_OS_FLAVOR_NAME: "o2.medium"
 OS_FLAVOR_NAME: "o2.medium"
 LARGEST_FLAVOR_NAME: "o2.medium"
 OS_NETWORK_IDS: "docker_runners"
 NFS_HOST_IP: "192.168.252.42"

default:
  image:
   name: gitlab-registry.internal.sanger.ac.uk/isg/gitlab-ci-docker-docker

stages:
 - init_openstack
 - build_openstack
 - cleanup_build
 - test_openstack
 - cleanup_test
 - store

.job_template: &validate
  stage: init_openstack
  tags:
   - packer-autoscale-theta-beta
  retry: 2
  script:
   - export TEMPLATE="${TEMPLATE:-template-openstack-ubuntu.json}"
   - . $(packer/scripts/make_venv.sh | tail -1 )/bin/activate
   - cd packer
   - ./create_image.py validate --packer-location "${USE_PACKER_BIN}" -tf "${TEMPLATE}" -vf variables.json

.job_template: &build
 stage: build_openstack
 tags:
  - packer-autoscale-theta-beta
 retry: 2
 script:
  - . $(packer/scripts/make_venv.sh | tail -1 )/bin/activate
  - for i in $(echo $OS_NETWORK_IDS| sed 's/,/\n/g'); do echo $i; NET=$(openstack network show $i -c id -f value); NETS=$(echo "${NETS},${NET}" | sed -e 's/,,*/,/g' -e 's/^,//g'); echo $NETS; done
  - export OS_NETWORK_IDS="$NETS"
  - export TEMPLATE="${TEMPLATE:-template-openstack-ubuntu.json}"
  - cd packer
  - export OLD_IMAGE="$(openstack image list -f value -c ID -c Name| grep -w "${IMAGE_NAME}"_"${CI_BUILD_REF}" | grep -v "old-" |  cut -d " " -f 2)"
  - if [ -n "$OLD_IMAGE" ]; then openstack image set "$OLD_IMAGE" --name "old-$OLD_IMAGE"; fi
  - ./create_image.py build --packer-location "${USE_PACKER_BIN}" -tf "${TEMPLATE}" -vf variables.json -p openstack -o "${IMAGE_NAME}"_"${CI_BUILD_REF}"

.job_template: &test
 stage: test_openstack
 tags:
  - packer-autoscale-theta-beta
 retry: 2
 script:
  - export MODE="${MODE:-default}"
  - export IMAGE_USERNAME="${IMAGE_USERNAME:-ubuntu}"
  - export OS_BASE_IMAGE=$(openstack image list -f value | grep -w "${IMAGE_NAME}"_"${CI_BUILD_REF}" | grep -v "old-" | cut -d " " -f 1)
  - export http_proxy=""
  - export http_proxys=""
  - export KEYPAIR=$( (echo -n $PLATFORM ; echo -n $MODE ; date +%s-%N )| md5sum | cut -d " " -f 1)
  - ./kitchen_wrapper.sh

.job_template: &clean
 stage: cleanup_build
 tags:
  - packer-autoscale-theta-beta
 retry: 1
 script:
  - . $(packer/scripts/make_venv.sh | tail -1 )/bin/activate
  - cd packer
  - ./remove_failed_builds.py -i "${IMAGE_NAME}_${CI_PIPELINE_ID}"
 when: on_failure

.job_template: &store
 stage: store
 tags:
  - packer-autoscale-theta-beta
 script:
  - echo "$IMAGE_NAME"
  - packer/scripts/upload_image.sh


validate_template_bionic_openstack_lustre:
 <<: *validate
 before_script:
  - export IMAGE_NAME="$IMAGE_NAME_BIONIC_LUSTRE"
  - export OS_BASE_IMAGE="$OS_BASE_IMAGE_BIONIC"

validate_template_bionic_openstack_lustre_docker:
 <<: *validate
 before_script:
  - export IMAGE_NAME="$IMAGE_NAME_BIONIC_LUSTRE_DOCKER"
  - export OS_BASE_IMAGE="$OS_BASE_IMAGE_BIONIC"

build_openstack_bionic_lustre:
 <<: *build
 needs: ["validate_template_bionic_openstack_lustre"]
 before_script:
  - export IMAGE_NAME="$IMAGE_NAME_BIONIC_LUSTRE"
  - export OS_BASE_IMAGE="$(openstack image show -c id -f value $OS_BASE_IMAGE_BIONIC)"

build_openstack_bionic_lustre_docker:
 <<: *build
 needs: ["validate_template_bionic_openstack_lustre_docker"]
 before_script:
  - export CONTAINER=true
  - export IMAGE_NAME="$IMAGE_NAME_BIONIC_LUSTRE_DOCKER"
  - export OS_BASE_IMAGE="$(openstack image show -c id -f value $OS_BASE_IMAGE_BIONIC)"

clean_build_openstack_bionic_lustre:
  <<: *clean
  needs: ["build_openstack_bionic_lustre"]
  before_script:
    - export IMAGE_NAME="$IMAGE_NAME_BIONIC_LUSTRE"

clean_build_openstack_bionic_lustre_docker:
  <<: *clean
  needs: ["build_openstack_bionic_lustre_docker"]
  before_script:
    - export IMAGE_NAME="$IMAGE_NAME_BIONIC_LUSTRE_DOCKER"

test_openstack_no_disk_bionic_lustre:
 <<: *test
 needs: ["build_openstack_bionic_lustre"]
 before_script:
  - export IMAGE_NAME="$IMAGE_NAME_BIONIC_LUSTRE"
  - export PLATFORM="ubuntu-18.04"

test_openstack_disk_bionic_lustre:
 <<: *test
 needs: ["build_openstack_bionic_lustre"]
 before_script:
  - export IMAGE_NAME="$IMAGE_NAME_BIONIC_LUSTRE"
  - export MODE=volume
  - export PLATFORM="ubuntu-18.04"

test_openstack_no_disk_bionic_lustre_docker:
 <<: *test
 needs: ["build_openstack_bionic_lustre_docker"]
 before_script:
  - export CONTAINER=true
  - export IMAGE_NAME="$IMAGE_NAME_BIONIC_LUSTRE_DOCKER"
  - export PLATFORM="ubuntu-18.04"
  - export MODE=default-docker

test_openstack_disk_bionic_lustre_docker:
 <<: *test
 needs: ["build_openstack_bionic_lustre_docker"]
 before_script:
  - export CONTAINER=true
  - export IMAGE_NAME="$IMAGE_NAME_BIONIC_LUSTRE_DOCKER"
  - export MODE=volume-docker
  - export PLATFORM="ubuntu-18.04"

clean_test_openstack_bionic_lustre:
  <<: *clean
  needs: ["test_openstack_disk_bionic_lustre","test_openstack_no_disk_bionic_lustre"]
  stage: cleanup_test
  before_script:
    - export IMAGE_NAME="$IMAGE_NAME_BIONIC_LUSTRE"

clean_test_openstack_bionic_lustre_docker:
  <<: *clean
  needs: ["test_openstack_disk_bionic_lustre_docker","test_openstack_no_disk_bionic_lustre_docker"]
  stage: cleanup_test
  before_script:
    - export IMAGE_NAME="$IMAGE_NAME_BIONIC_LUSTRE_DOCKER"

store_openstack_image_bionic_lustre:
  <<: *store
  needs: ["test_openstack_disk_bionic_lustre","test_openstack_no_disk_bionic_lustre"]
  before_script:
   - export IMAGE_NAME="$IMAGE_NAME_BIONIC_LUSTRE"

store_openstack_image_bionic_lustre_docker:
  <<: *store
  needs: ["test_openstack_disk_bionic_lustre_docker","test_openstack_no_disk_bionic_lustre_docker"]
  before_script:
   - export IMAGE_NAME="$IMAGE_NAME_BIONIC_LUSTRE_DOCKER"
