variables:
 OS_NO_CACHE: "True"
 COMPUTE_API_VERSION: "1.1"
 no_proxy: ",172.31.0.18"
 OS_CLOUDNAME: "overcloud"
 OS_AUTH_URL: "http://openstack-gamma.internal.sanger.ac.uk:5000/v2.0/"
 NOVA_VERSION: "1.1"
 PACKER_BIN: "/home/gitlab-runner/packer-0.9.1"
 OS_BASE_IMAGE: "8f50f1c3-b094-492b-8c73-191a8f1f5582"
 IMAGE_NAME: "ubuntu_14_04_4_WTSI_standard"
 OS_SECURITY_GRP: "ssh"
 VMWARE_BUILD_HOST: "wtgc-vmbd-01.internal.sanger.ac.uk"
 http_proxy: "http://wwwcache.sanger.ac.uk:3128"
 https_proxy: "http://wwwcache.sanger.ac.uk:3128"


stages:
 - init
 - build
 - cleanup_build
 - test
 - cleanup_test
 - store

validate_template:
  stage: init
  tags: 
   - packer
  script:
   - ./create_image.py validate -vf variables.json 

build_openstack:
 stage: build
 tags:
  - packer
 script:
  - ./create_image.py build -d local -vf variables.json -p openstack -o "${IMAGE_NAME}"_"${CI_BUILD_REF}"


build_vmware:
  stage: build
  tags:
   - packer
  script:
   - sshpass -p $VMWARE_PASSWORD scp -oStrictHostKeyChecking=no vmbuildadmin@wtgc-vmbd-01.internal.sanger.ac.uk:~/vmware_private_key.pem .
   - IMAGE_NAME=${IMAGE_NAME}"_"$(date +%Y%m%d%H%M%S )
   - ./create_image.py build -d local -vf variables.json -p vmware-iso -o "${IMAGE_NAME}"_"${CI_BUILD_REF}"
   - mv $IMAGE_NAME/ /warehouse/isg_warehouse/SciaaS_images/vmware 
   - rm vmware_private_key.pem

cleanup_openstack_build:
  stage: cleanup_build
  tags:
   - packer
  script:
   - ./remove_failed_builds.py
  when: on_failure


test_openstack_no_disk:
  stage: test
  tags:
   - openstack
   - kitchen
  script:
  - export OS_BASE_IMAGE=$(openstack image list -f value | grep -w "${IMAGE_NAME}"_"${CI_BUILD_REF}" |  cut -d " " -f 1)
  - export MODE=default
  - export KEYPAIR=$(date +%s-%N | md5sum | cut -d " " -f 1)
  - echo "Using $OS_BASE_IMAGE ( ${IMAGE_NAME}_${CI_BUILD_REF} ) "
  - openstack keypair create $KEYPAIR >> $KEYPAIR
  - http_proxy="" https_proxy=""  kitchen test -l debug
  - kitchen destroy
  - openstack keypair delete $KEYPAIR

test_openstack_disk:
  stage: test
  tags:
   - openstack
   - kitchen
  script:
  - export OS_BASE_IMAGE=$(openstack image list -f value | grep -w "${IMAGE_NAME}"_"${CI_BUILD_REF}" |  cut -d " " -f 1)
  - export MODE=volume
  - export KEYPAIR=$(date +%s-%N | md5sum | cut -d " " -f 1)
  - echo "Using $OS_BASE_IMAGE ( ${IMAGE_NAME}_${CI_BUILD_REF} ) " 
  - openstack keypair create $KEYPAIR >> $KEYPAIR
  - http_proxy="" https_proxy="" kitchen test -l debug
  - kitchen destroy
  - openstack keypair delete $KEYPAIR

cleanup_openstack_test:
  stage: cleanup_build
  tags:
   - packer
  script:
   - ./remove_failed_builds.py
  when: on_failure

store_openstack_image:
  stage: store
  tags:
  - packer
  script:
  - ./cleanup.py -dt "${IMAGE_NAME}"_"${CI_BUILD_REF}" "${IMAGE_NAME}"

